[gd_scene load_steps=21 format=2]

[ext_resource path="res://Player.tscn" type="PackedScene" id=2]
[ext_resource path="res://darksky.png" type="Texture" id=3]
[ext_resource path="res://DirectionalLight.gd" type="Script" id=4]
[ext_resource path="res://futuristic low poly city by niko.glb" type="PackedScene" id=5]
[ext_resource path="res://ChainChomp.tscn" type="PackedScene" id=6]

[sub_resource type="BoxShape" id=6]
extents = Vector3( 32.0145, 1, 28.0035 )

[sub_resource type="CubeMesh" id=2]
size = Vector3( 1, 1, 1 )

[sub_resource type="Shader" id=17]
code = "shader_type spatial;

uniform vec3 scale = vec3(2.0);
uniform float width: hint_range(0.0, 10.0) = 0.25;
uniform float sharpness: hint_range(0.0, 1.0) = 0.5;
uniform float glow: hint_range(1.0, 16.0) = 4.0;
uniform vec4 color: hint_color = vec4(1.0);
uniform sampler2D tex: hint_albedo;

varying vec3 vert;
varying vec3 normal;

void vertex(){
	VERTEX += sign(VERTEX) * (scale - 1.0) * 0.5;
	
	vert = VERTEX;
	normal = abs(NORMAL);
}

void fragment(){
	vec3 fv = fract(vec3(vert.x, vert.y * -1.0, vert.z));
	vec3 vs = abs(vert) - scale * 0.5;
	float ws = width * sharpness;
	
	ALBEDO = (texture(tex, fv.zy).rgb * normal.x + texture(tex, fv.xz).rgb * normal.y + texture(tex, fv.xy).rgb * normal.z) * float(width < length(vs.xy)) * float(width < length(vs.yz)) * float(width < length(vs.xz));
	EMISSION = (1.0 - smoothstep(ws, width, length(vs.xy)) * smoothstep(ws, width, length(vs.yz)) * smoothstep(ws, width, length(vs.xz))) * color.rgb * glow;
}"

[sub_resource type="Gradient" id=19]
offsets = PoolRealArray( 0, 0.270968, 1 )
colors = PoolColorArray( 0, 0, 0, 1, 0.130371, 0.0127316, 0.0127316, 1, 0, 0, 0, 1 )

[sub_resource type="GradientTexture" id=20]
gradient = SubResource( 19 )

[sub_resource type="ShaderMaterial" id=18]
shader = SubResource( 17 )
shader_param/scale = Vector3( 2, 2, 2 )
shader_param/width = 0.025
shader_param/sharpness = 0.5
shader_param/glow = 16.0
shader_param/color = Color( 1, 0.188235, 0.188235, 1 )
shader_param/tex = SubResource( 20 )

[sub_resource type="BoxShape" id=1]
extents = Vector3( 10, 1, 10 )

[sub_resource type="SpatialMaterial" id=7]
albedo_color = Color( 0.819608, 0.819608, 0.819608, 1 )

[sub_resource type="CubeMesh" id=8]
size = Vector3( 60, 60, 60 )

[sub_resource type="Shader" id=12]
code = "/*
	六角形縁 by あるる（きのもと 結衣）
	Hex Line Shader by Yui Kinomoto @arlez80

	MIT License
*/

shader_type spatial;
render_mode unshaded;

const float PI = 3.1415926535;

uniform vec2 hex_size = vec2( 0.05, 0.08 );
uniform vec4 scan_color : hint_color = vec4( 0.0, 1.0, 0.3, 1.0 );
uniform float scan_line_size : hint_range( 0.0, 0.025 ) = 0.001;

vec2 get_hex_uv( vec2 uv )
{
	bool half = mod( uv.y / 2.0, hex_size.y ) / hex_size.y < 0.5;
	vec2 half_shift_uv = uv + vec2( hex_size.x * 0.5 * float( half ), 0.0 );
	vec2 hex_uv = floor( half_shift_uv / hex_size ) * hex_size;
	vec2 norm_uv = mod( half_shift_uv, hex_size ) / hex_size;

	return hex_uv + mix(
		vec2( 0.0, 0.0 )
	,	mix(
			mix(
				vec2( hex_size.x, -hex_size.y )
			,	vec2( 0.0, -hex_size.y )
			,	float( norm_uv.x < 0.5 )
			)
		,	mix(
				vec2( 0.0, -hex_size.y )
			,	vec2( -hex_size.x, -hex_size.y )
			,	float( norm_uv.x < 0.5 )
			)
		,	float( half )
		)
	,	float( norm_uv.y < 0.3333333 ) * float( norm_uv.y / 0.3333333 < ( abs( norm_uv.x - 0.5 ) * 2.0 ) )
	);
}

void fragment( )
{
	vec2 hex_uv[9];

	for( int y=0; y<3; y ++ ) {
		for( int x=0; x<3; x ++ ) {
			hex_uv[y*3+x] = get_hex_uv( UV + vec2( scan_line_size * float( x - 1 ), scan_line_size * float( y - 1 ) ) );
		}
	}

	vec2 sobel_src_x = (
		hex_uv[0] * -1.0
	+	hex_uv[3] * -2.0
	+	hex_uv[6] * -1.0
	+	hex_uv[2] * 1.0
	+	hex_uv[5] * 2.0
	+	hex_uv[8] * 1.0
	);
	vec2 sobel_src_y = (
		hex_uv[0] * -1.0
	+	hex_uv[1] * -2.0
	+	hex_uv[2] * -1.0
	+	hex_uv[6] * 1.0
	+	hex_uv[7] * 2.0
	+	hex_uv[8] * 1.0
	);
	vec2 sobel = sqrt( sobel_src_x * sobel_src_x + sobel_src_y * sobel_src_y );

	ALBEDO = scan_color.rgb;
	ALPHA = scan_color.a * float( 0.01 < length( sobel ) );
}

	/*
	//	中心位置からの距離を出すけど、普通に二次元距離なので役にたたない
	//	六角形を三次元で扱う方法でやったほうがいい
	float hex_x1 = abs( mod( UV.x / size.x + 0.5, 1.0 ) - 0.5 );
	float hex_x2 = abs( mod( UV.x / size.x, 1.0 ) - 0.5 );
	vec2 dist_uv = vec2(
		mix(
			hex_x1
		,	hex_x2
		,	float( mod( UV.y / 2.0, size.y ) / size.y - hex_x1 * 0.3333333 < 0.0 )
		+	float( 0.0 < mod( UV.y / 2.0, size.y ) / size.y - 0.5 - hex_x2 * 0.3333333 )
		) * 1.666666
	,	abs( hex_uv.y - half_shift_uv.y + size.y * 0.65 ) / size.y
	);
	*/
"

[sub_resource type="ShaderMaterial" id=13]
shader = SubResource( 12 )
shader_param/hex_size = Vector2( 0.05, 0.08 )
shader_param/scan_color = Color( 0, 1, 0.3, 1 )
shader_param/scan_line_size = 0.002

[sub_resource type="Animation" id=10]
length = 0.001
tracks/0/type = "value"
tracks/0/path = NodePath(".:rotation_degrees")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 0,
"values": [ Vector3( -18.8952, -20.6066, 8.07957 ) ]
}

[sub_resource type="Animation" id=11]
resource_name = "rotate"
length = 12.0
loop = true
tracks/0/type = "value"
tracks/0/path = NodePath(".:rotation_degrees")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 6, 12 ),
"transitions": PoolRealArray( 1, 1, 1 ),
"update": 0,
"values": [ Vector3( 180, 99, 8.08 ), Vector3( 0, 60, 8.08 ), Vector3( -180, 99, 8.08 ) ]
}

[sub_resource type="PanoramaSky" id=16]
panorama = ExtResource( 3 )

[sub_resource type="Environment" id=15]
background_mode = 2
background_sky = SubResource( 16 )
ambient_light_color = Color( 1, 1, 1, 1 )
glow_enabled = true

[node name="Level 1" type="Spatial"]

[node name="The Floor" type="StaticBody" parent="."]

[node name="CollisionShape" type="CollisionShape" parent="The Floor"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0.700649, 0.0428658, 0.580002 )
shape = SubResource( 6 )

[node name="MeshInstance" type="MeshInstance" parent="The Floor"]
transform = Transform( 32, 0, 0, 0, 1, 0, 0, 0, 28, 0, 0, 0 )
mesh = SubResource( 2 )
material/0 = SubResource( 18 )

[node name="The Floor2" type="StaticBody" parent="."]
transform = Transform( 0.980611, 0.195964, 0, -0.195964, 0.980611, 0, 0, 0, 1, -36.2064, 1.86202, 16.9578 )

[node name="CollisionShape" type="CollisionShape" parent="The Floor2"]
shape = SubResource( 1 )

[node name="MeshInstance" type="MeshInstance" parent="The Floor2"]
transform = Transform( 20, -4.76838e-08, 0, 4.76838e-07, 2, 0, 0, 0, 20, 0, 0, 0 )
mesh = SubResource( 2 )
material/0 = SubResource( 7 )

[node name="DirectionalLight" type="DirectionalLight" parent="."]
transform = Transform( -0.493259, 0.713311, -0.497878, 0.502031, 0.700847, 0.506732, 0.710394, 6.25035e-08, -0.703804, -26.6248, 28, -25.1334 )
shadow_enabled = true
shadow_color = Color( 0.678431, 0.678431, 0.678431, 1 )
script = ExtResource( 4 )

[node name="Player" parent="." instance=ExtResource( 2 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, -4.44956, 20.8877, 2.56566 )

[node name="MeshInstance" type="MeshInstance" parent="."]
transform = Transform( 0.942747, -0.0187125, -0.332984, 0.132974, 0.936721, 0.323838, 0.305853, -0.349576, 0.885579, 0, -67.3821, 0 )
mesh = SubResource( 8 )
material/0 = SubResource( 13 )

[node name="AnimationPlayer" type="AnimationPlayer" parent="MeshInstance"]
autoplay = "rotate"
anims/RESET = SubResource( 10 )
anims/rotate = SubResource( 11 )

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource( 15 )

[node name="futuristic low poly city by niko" parent="." instance=ExtResource( 5 )]
transform = Transform( 3, 0, 0, 0, 3, 0, 0, 0, 3, 21.8631, -101.402, -110.836 )

[node name="ChainChomp" parent="." instance=ExtResource( 6 )]
transform = Transform( -0.0041466, 0.00253199, 0.199941, 0.00494346, 0.199924, -0.00242927, -0.199896, 0.00489112, -0.00420761, 7.72449, 1.71805, 1.36346 )

[node name="The Floor4" type="StaticBody" parent="."]
transform = Transform( 0.923196, 0.384329, 0, -0.384329, 0.923196, 0, 0, 0, 1, -45.2874, 4.61522, 24.8243 )

[node name="CollisionShape" type="CollisionShape" parent="The Floor4"]
shape = SubResource( 1 )

[node name="MeshInstance" type="MeshInstance" parent="The Floor4"]
transform = Transform( 20, -4.76838e-08, 0, 4.76838e-07, 2, 0, 0, 0, 20, 0, 0, 0 )
mesh = SubResource( 2 )
skeleton = NodePath("../../The Floor4")
material/0 = SubResource( 7 )

[node name="Spatial" type="Spatial" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 31, 1, 26 )

[connection signal="sendmyposition" from="Player" to="ChainChomp" method="_on_Player_sendmyposition"]
[connection signal="sendmeplayerposition" from="ChainChomp" to="Player" method="_on_ChainChomp_sendmeplayerposition"]
